#!/usr/bin/env node
const ctftime = require('ctftime-scraper')
const fs = require('fs')
const path = require('path')

const writeupsPath = path.join(__dirname, '..', 'data', 'writeups.json')
const currentWriteups = require(writeupsPath)

function normalizeWriteup (writeup) {
  return {
    challenge: writeup.taskName,
    ctf: writeup.eventName,
    id: writeup.id
  }
}

function getWriteup (writeup) {
  return ctftime.getWriteup(writeup.id)
    .then((data) => {
      return Object.assign(normalizeWriteup(writeup), { link: data.originalUrl })
    })
}

ctftime.getTeam(32119)
  .then((team) => {
    return Promise.all(team.writeups.map(getWriteup))
  })
  .then((writeups) => {
    if (writeups != currentWriteups) {
      const json = JSON.stringify(writeups, null, 2)
      fs.writeFileSync(writeupsPath, json)
    }
  })
  .catch((error) => {
    throw error
  })